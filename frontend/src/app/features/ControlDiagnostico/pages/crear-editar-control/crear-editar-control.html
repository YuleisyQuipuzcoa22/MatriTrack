<div class="fondo d-flex justify-content-center align-items-center min-vh-100">
  <div class="card-container-wide"> 
    <div class="header text-center">
      <h2 class="titulo">{{ isEditMode ? 'EDITAR CONTROL' : 'NUEVO CONTROL DIAGNÓSTICO' }}</h2>
      <p class="subtitulo">Programa: {{ programaId }}</p>
      @if (isEditMode && fechaCreacion) {
        <p class="subtitulo">Fecha de Control: <strong>{{ fechaCreacion }}</strong></p>
      }
    </div>

    @if (isLoading) {
      <div class="text-center p-5">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando datos del control...</p>
      </div>
    }

    <form [formGroup]="controlForm" (ngSubmit)="guardar()" class="formulario" *ngIf="!isLoading">
      <h3 class="section-title mt-4 mb-3">1. Datos Generales</h3>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="label"><i class="bi bi-calendar-week me-2"></i>Semana de gestación <span class="text-danger">*</span></label>
          <input type="number" class="form-control" formControlName="semana_gestacion" placeholder="Ej. 28" />
          @if (isInvalid('semana_gestacion')) {
            <small class="text-danger">{{ getErrorMessage('semana_gestacion') }}</small>
          }
        </div>

        <div class="col-md-6 mb-3">
          <label class="label"><i class="bi bi-heart-pulse me-2"></i>Presión arterial <span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="presion_arterial" placeholder="Ej. 110/70" />
          @if (isInvalid('presion_arterial')) {
            <small class="text-danger">{{ getErrorMessage('presion_arterial') }}</small>
          }
        </div>
      </div>

      <h3 class="section-title mt-4 mb-3">2. Signos Vitales y Medidas</h3>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="label"><i class="bi bi-person-arms-up me-2"></i>Peso (kg) <span class="text-danger">*</span></label>
          <input type="number" step="0.1" class="form-control" formControlName="peso" placeholder="Ej. 64.5" />
          @if (isInvalid('peso')) {
            <small class="text-danger">{{ getErrorMessage('peso') }}</small>
          }
        </div>

        <div class="col-md-4 mb-3">
          <label class="label"><i class="bi bi-rulers me-2"></i>Talla (m) <span class="text-danger">*</span></label>
          <input type="number" step="0.01" class="form-control" formControlName="talla" placeholder="Ej. 1.65" />
          @if (isInvalid('talla')) {
            <small class="text-danger">{{ getErrorMessage('talla') }}</small>
          }
        </div>

        <div class="col-md-4 mb-3">
          <label class="label"><i class="bi bi-activity me-2"></i>Altura uterina (cm)</label>
          <input type="number" step="0.1" class="form-control" formControlName="altura_uterina" placeholder="Ej. 28" />
          @if (isInvalid('altura_uterina')) {
            <small class="text-danger">{{ getErrorMessage('altura_uterina') }}</small>
          }
        </div>

        <div class="col-md-6 mb-3">
          <label class="label"><i class="bi bi-soundwave me-2"></i>Frecuencia cardíaca fetal (lpm)</label>
          <input type="number" class="form-control" formControlName="fcf" placeholder="Ej. 140" />
          @if (isInvalid('fcf')) {
            <small class="text-danger">{{ getErrorMessage('fcf') }}</small>
          }
        </div>
      </div>

      <h3 class="section-title mt-4 mb-3">3. Observaciones y Recomendaciones</h3>
      <div class="row">
        <div class="col-12 mb-3">
          <label class="label"><i class="bi bi-journal-text me-2"></i>Observación</label>
          <textarea class="form-control" formControlName="observacion" rows="3"
            placeholder="Ej. Paciente refiere movimientos fetales normales."></textarea>
          @if (isInvalid('observacion')) {
            <small class="text-danger">{{ getErrorMessage('observacion') }}</small>
          }
        </div>

        <div class="col-12 mb-3">
          <label class="label"><i class="bi bi-card-checklist me-2"></i>Recomendación</label>
          <textarea class="form-control" formControlName="recomendacion" rows="3"
            placeholder="Ej. Control en 2 semanas, continuar suplementos prenatales."></textarea>
          @if (isInvalid('recomendacion')) {
            <small class="text-danger">{{ getErrorMessage('recomendacion') }}</small>
          }
        </div>
      </div>

      @if (errorMessage) {
        <div class="alert alert-danger text-center mt-3">{{ errorMessage }}</div>
      }

      <div class="button-group">
        <button type="button" class="btn-volver" (click)="cancelar()" [disabled]="isLoading">
          ← Volver al Listado
        </button>

        <button type="submit" class="btn-submit" [disabled]="controlForm.invalid || isLoading">
          @if (isLoading) {
            <span class="spinner-border spinner-border-sm me-2"></span> Guardando...
          } @else {
            <i class="bi bi-check-circle me-2"></i>
            {{ isEditMode ? 'Guardar Cambios' : 'Crear Control' }}
          }
        </button>
      </div>
    </form>
  </div>
</div>

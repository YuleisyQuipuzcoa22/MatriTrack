<div class="fondo d-flex justify-content-center align-items-center min-vh-100">
  <div class="card-container">
    <div class="header text-center">
      <h2 class="titulo">{{ isEditMode ? 'EDITAR USUARIO' : 'CREAR CUENTA' }}</h2>
      <p class="subtitulo">
        {{
          isEditMode ? 'Modifica los datos del usuario seleccionado' : 'Registra un nuevo usuario'
        }}
      </p>
      <img
        src="https://yt3.googleusercontent.com/dSnqcXzoOXSJp35-I_9lPnUTa3M9qOuck07IS_UlvCz3lmBRQ8uohBfqb5GRzeOAdZjWKmeD=s900-c-k-c0x00ffffff-no-rj"
        alt="Logo"
        class="logo"
      />
    </div>

    @if (isLoading && isEditMode) {
    <div class="text-center p-5">
      <p>Cargando datos del usuario...</p>
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    } @else {
    <form [formGroup]="registerForm" (ngSubmit)="onSubmit()" class="formulario">
      <div class="row">
        <!-- DNI (Deshabilitado en Edición) -->
        <div class="col-md-6 mb-3">
          <label class="label">DNI</label>
          <!-- Usamos [readonly]="isEditMode" para mejor UX, pero el disable en TS es más seguro -->
          <input type="text" formControlName="dni" class="form-control" placeholder="DNI" />
          @if (registerForm.get('dni')?.invalid && registerForm.get('dni')?.touched) {
          <small class="text-danger">El DNI debe tener 8 dígitos numéricos.</small>
          }
        </div>

        <!-- Rol -->
        <div class="col-md-6 mb-3">
          <label class="label">Rol</label>
          <select
            formControlName="rol"
            class="form-select"
            [attr.disabled]="isEditMode ? true : null"
          >
            <option value="" disabled selected>Seleccione Rol</option>
            @for (r of roles; track r) {
            <option [value]="r">{{ r }}</option>
            }
          </select>
        </div>

        <div class="col-md-6 mb-3">
          <label class="label">Nombre(s)</label>
          <input
            type="text"
            formControlName="nombre"
            class="form-control"
            placeholder="Nombre(s)"
          />
          @if (registerForm.get('nombre')?.invalid && registerForm.get('nombre')?.touched) {
          <small class="text-danger">El nombre es obligatorio.</small>
          }
        </div>

        <div class="col-md-6 mb-3">
          <label class="label">Apellido(s)</label>
          <input
            type="text"
            formControlName="apellido"
            class="form-control"
            placeholder="Apellido(s)"
          />
          @if (registerForm.get('apellido')?.invalid && registerForm.get('apellido')?.touched) {
          <small class="text-danger">El apellido es obligatorio.</small>
          }
        </div>

        <!-- Correo Electrónico -->
        <div class="col-md-6 mb-3">
          <label class="label">Correo Electrónico</label>
          <input
            type="email"
            formControlName="correo_electronico"
            class="form-control"
            placeholder="Correo Electrónico"
            [attr.disabled]="isEditMode ? true : null"
          />
          @if (registerForm.get('correo_electronico')?.invalid &&
          registerForm.get('correo_electronico')?.touched) {
          <small class="text-danger">Ingrese un correo válido.</small>
          }
        </div>

        <div class="col-md-6 mb-3">
          <label class="label">Teléfono</label>
          <input
            type="text"
            formControlName="telefono"
            class="form-control"
            placeholder="Teléfono"
          />
          @if (registerForm.get('telefono')?.invalid && registerForm.get('telefono')?.touched) {
          <small class="text-danger">Ingrese un número válido.</small>
          }
        </div>

        <div class="col-md-6 mb-3">
          <label class="label">Fecha de Nacimiento</label>
          <input type="date" formControlName="fecha_nacimiento" class="form-control" />
          @if (registerForm.get('fecha_nacimiento')?.invalid &&
          registerForm.get('fecha_nacimiento')?.touched) {
          <small class="text-danger">La fecha es obligatoria.</small>
          }
        </div>

        <!-- Dirección: Nuevo campo obligatorio -->
         <div class="col-md-6 mb-3">
          <label class="label">Dirección</label>
          <input
            type="text"
            formControlName="direccion"
            class="form-control"
            placeholder="Dirección"
          />
          @if (registerForm.get('direccion')?.invalid && registerForm.get('direccion')?.touched) {
          <small class="text-danger">La dirección es obligatoria.</small>
          }
        </div>

        <!-- N° Colegiatura: Mantenemos la lógica de visibilidad/validación según el rol -->
        
        <div class="col-md-6 mb-3">
          <label class="label">N° Colegiatura</label>
          <input
            type="text"
            formControlName="numero_colegiatura"
            class="form-control"
            placeholder="N° Colegiatura"
          />
          @if (registerForm.get('numero_colegiatura')?.invalid &&
          registerForm.get('numero_colegiatura')?.touched) {
          <small class="text-danger">Debe tener al menos 6 caracteres.</small>
          }
        </div>

        

        <!-- Contraseña: SOLO visible en modo Registro -->
        @if (!isEditMode) {
        <div class="col-12 mb-3 password-group">
          <label class="label">Contraseña</label>
          <div class="input-group">
            <input
              type="text"
              formControlName="contrasena"
              readonly
              class="form-control bg-light"
              placeholder="Contraseña generada"
            />
            <button type="button" class="btn-generate" (click)="regeneratePassword()">
              Generar Nueva
            </button>
          </div>
        </div>
        }
      </div>

      <div class="text-center mt-4">
        <button type="submit" class="btn-submit" [disabled]="registerForm.invalid || isLoading">
          @if (isLoading) {
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Cargando... } @else {
          {{ isEditMode ? 'Guardar Cambios' : 'Registrar Usuario' }}
          }
        </button>
        <a routerLink="/obstetras" class="btn-volver">← Volver</a>
      </div>

      @if (errorMessage) {
      <div class="alert alert-danger mt-3 text-center">{{ errorMessage }}</div>
      } @if (successMessage) {
      <div class="alert alert-success mt-3 text-center">{{ successMessage }}</div>
      }
    </form>
    }  
  </div>
</div>

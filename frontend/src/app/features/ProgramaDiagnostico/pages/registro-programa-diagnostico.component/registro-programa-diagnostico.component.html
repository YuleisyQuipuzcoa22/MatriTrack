<!-- Contenedor Principal -->
<div class="flex justify-center items-start min-h-screen bg-gray-50 p-4 sm:p-8">
    <div class="w-full max-w-4xl bg-white shadow-xl rounded-xl p-6 sm:p-10 border border-gray-200">

        <!-- Encabezado Dinámico -->
        <h1 class="text-3xl font-extrabold text-blue-800 mb-6 border-b pb-2">
            {{ isEditMode ? 'Editar Programa Diagnóstico' : 'Nuevo Programa Diagnóstico' }}
        </h1>

        <!-- Mensajes de Error/Carga -->
        @if (errorMessage) {
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-6" role="alert">
                <p class="font-bold">Error:</p>
                <p class="text-sm">{{ errorMessage }}</p>
            </div>
        }
        @if (isLoading) {
            <div class="flex justify-center items-center p-4 mb-6">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Cargando...
            </div>
        }

        <!-- 1. MODO BÚSQUEDA (Solo en MODO REGISTRO) -->
        @if (isSearchMode && !isEditMode) {
            <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                <h2 class="text-xl font-semibold text-blue-700 mb-4">Paso 1: Buscar Paciente por DNI</h2>
                
                <form [formGroup]="searchForm" (ngSubmit)="buscarPaciente()" class="space-y-4">
                    <div class="mb-4">
                        <label for="dni" class="block text-sm font-medium text-gray-700">DNI del Paciente</label>
                        <input id="dni" type="text" formControlName="dni" 
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Ej: 12345678">
                        @if (searchForm.get('dni')?.invalid && (searchForm.get('dni')?.dirty || searchForm.get('dni')?.touched)) {
                            <div class="text-red-500 text-xs mt-1">
                                El DNI es obligatorio y debe contener entre 8 y 10 dígitos.
                            </div>
                        }
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" (click)="onBack()" class="btn-secondary">
                            <i class="fas fa-arrow-left"></i> Volver a Diagnósticos
                        </button>
                        <button type="submit" [disabled]="searchForm.invalid || isLoading" class="btn-primary">
                            <i class="fas fa-search"></i> Buscar Paciente
                        </button>
                    </div>
                </form>
            </div>
        } 

        <!-- 2. MODO REGISTRO/EDICIÓN -->
        @if (!isSearchMode && !isLoading) {
            <!-- Información del Paciente (Solo en modo registro y después de la búsqueda) -->
            @if (pacienteEncontrado && !isEditMode) {
                <div class="bg-green-50 p-4 rounded-lg border border-green-200 mb-6 flex justify-between items-center">
                    <div>
                        <p class="text-sm font-medium text-green-700">Paciente Seleccionado:</p>
                        <p class="text-xl font-bold text-green-800">{{ pacienteNombreCompleto }}</p>
                        <p class="text-sm text-green-600">Historial ID: {{ pacienteEncontrado.historialMedico.id_historialmedico }}</p>
                    </div>
                    <button type="button" (click)="volverABusqueda()" class="btn-tertiary">
                        Cambiar Paciente
                    </button>
                </div>
            } @else if (isEditMode) {
                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mb-6">
                    <p class="text-sm font-medium text-yellow-700">Editando Programa para:</p>
                    <p class="text-xl font-bold text-yellow-800">{{ pacienteNombreCompleto }}</p>
                </div>
            }

            <!-- Formulario de Programa Diagnóstico -->
            <form [formGroup]="programaForm" (ngSubmit)="onSubmit()" class="space-y-6">
                
                <h2 class="text-xl font-semibold text-gray-800 pb-2">Datos del Programa</h2>

                <!-- Numero de Gestación -->
                <div>
                    <label for="numero_gestacion" class="form-label required">Número de Gestación</label>
                    <input id="numero_gestacion" type="number" formControlName="numero_gestacion" min="1" max="20"
                            class="form-input" placeholder="Cantidad de gestaciones">
                    @if (programaForm.get('numero_gestacion')?.invalid && (programaForm.get('numero_gestacion')?.dirty || programaForm.get('numero_gestacion')?.touched)) {
                        <div class="text-red-500 text-xs mt-1">
                            El número de gestación es obligatorio (1 a 20).
                        </div>
                    }
                </div>

                <!-- Fecha Probable Parto -->
                <div>
                    <label for="fecha_probableparto" class="form-label">Fecha Probable de Parto</label>
                    <input id="fecha_probableparto" type="date" formControlName="fecha_probableparto"
                            class="form-input">
                </div>

                <!-- Factor de Riesgo -->
                <div>
                    <label for="factor_riesgo" class="form-label">Factor de Riesgo</label>
                    <input id="factor_riesgo" type="text" formControlName="factor_riesgo"
                            class="form-input" placeholder="Ej: Diabetes Gestacional, Edad avanzada">
                </div>

                <!-- Observación -->
                <div>
                    <label for="observacion" class="form-label">Observaciones (Máx. 1000 caracteres)</label>
                    <textarea id="observacion" formControlName="observacion" rows="4"
                                class="form-input resize-none" placeholder="Notas adicionales sobre el programa o el paciente."></textarea>
                    @if (programaForm.get('observacion')?.invalid && (programaForm.get('observacion')?.dirty || programaForm.get('observacion')?.touched)) {
                        <div class="text-red-500 text-xs mt-1">
                            La observación no puede exceder los 1000 caracteres.
                        </div>
                    }
                </div>

                <!-- Botones de Acción -->
                <div class="flex justify-end space-x-4 pt-4 border-t mt-6">
                    <button type="button" (click)="onBack()" class="btn-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" [disabled]="programaForm.invalid || isSubmitting" class="btn-primary">
                        @if (isSubmitting) {
                            <i class="fas fa-spinner animate-spin"></i>
                            Guardando...
                        } @else {
                            <i class="fas fa-save"></i>
                            {{ isEditMode ? 'Actualizar Programa' : 'Registrar Programa' }}
                        }
                    </button>
                </div>
            </form>
        }
    </div>
</div>

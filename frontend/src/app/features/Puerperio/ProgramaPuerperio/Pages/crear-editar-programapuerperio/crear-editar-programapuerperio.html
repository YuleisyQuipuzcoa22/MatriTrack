<div class="fondo">
  <div class="card-container-wide">
    <div class="header d-flex justify-content-between align-items-center">
      <div>
        <h1 class="titulo">
          <i class="bi bi-folder2-open me-2"></i>
          {{ isEditMode ? 'Editar Programa Puerperio' : 'Registrar Programa Puerperio' }}
        </h1>
        <p class="subtitulo">
          {{
            isEditMode
              ? 'Modifique los detalles del programa seleccionado.'
              : 'Busque al paciente (post-parto) y complete los datos del programa.'
          }}
        </p>
      </div>
    </div>

    <form [formGroup]="programaForm" (ngSubmit)="onSubmit()">
      
      @if(!isEditMode){
      <div class="bloque-busqueda">
        <h2 class="section-title">
          <i class="bi bi-search me-2"></i>
          Búsqueda de Paciente (Post-Parto)
        </h2>

        @if(!pacienteSeleccionado){
        <div class="row align-items-start">
          <div class="col-md-6">
            <label for="dniBusqueda" class="label">
              DNI del Paciente <span class="text-danger">*</span>
            </label>
            <div class="input-group"> <span class="input-group-text"><i class="bi bi-person-lines-fill"></i></span>
              <input
                type="text"
                id="dniBusqueda"
                formControlName="dniBusqueda"
                class="form-control"
                placeholder="Ingrese 8 dígitos"
                maxlength="8"
                [ngClass]="{ 'is-invalid': programaForm.get('dniBusqueda')?.invalid && programaForm.get('dniBusqueda')?.touched }"
                autocomplete="off"
              />
              <button
                type="button"
                class="btn-generate"
                (click)="triggerSearch()"
                [disabled]="programaForm.get('dniBusqueda')?.invalid || isSearchingPatient"
              >
                @if(isSearchingPatient){
                  <span class="spinner-border spinner-border-sm me-2"></span>
                } @if(!isSearchingPatient){
                  <i class="bi bi-search me-2"></i>
                }
                Buscar
              </button>
            </div>
             @if(programaForm.get('dniBusqueda')?.invalid && programaForm.get('dniBusqueda')?.touched){
              <small class="text-danger d-block mt-1">
                <i class="bi bi-exclamation-circle me-1"></i>
                @if(programaForm.get('dniBusqueda')?.errors?.['required']){
                  <span> El DNI es obligatorio. </span>
                } @if(programaForm.get('dniBusqueda')?.errors?.['pattern']){
                  <span> Debe ser un DNI válido de 8 dígitos. </span>
                }
              </small>
            }
          </div>
          <div class="col-md-6"> <div class="mensaje-instruccion">
              <i class="bi bi-info-circle"></i>
              <span>Solo se vincularán pacientes que hayan finalizado un programa de diagnóstico por "Parto" y no tengan un programa de puerperio activo.</span>
            </div>
          </div>
        </div>
        }

        @if(pacienteSeleccionado){
        <div class="info-paciente-seleccionado">
          <div class="paciente-datos">
            <div class="paciente-icono"><i class="bi bi-person-check-fill"></i></div>
            <div class="paciente-info">
              <h3 class="titulo-paciente">{{ pacienteSeleccionado.nombre_completo }}</h3>
              <div class="detalles-paciente">
                <span class="detalle-item"><i class="bi bi-credit-card"></i> DNI: {{ pacienteSeleccionado.dni }}</span>
                <span class="detalle-item"><i class="bi bi-calendar"></i> {{ pacienteSeleccionado.edad }} años</span>
                <span class="detalle-item"><i class="bi bi-clipboard2-pulse"></i> ID Historial: {{ pacienteSeleccionado.id_historialmedico }}</span>
              </div>
            </div>
          </div>
          <button type="button" class="btn-cambiar-paciente" (click)="cambiarPaciente()" title="Cambiar paciente">
            <i class="bi bi-arrow-left-right me-2"></i> Cambiar
          </button>
        </div>
        }
      </div>
      }
      
      <div class="mensajes-container">
        @if(errorMessage){
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ errorMessage }}
          <button type="button" class="btn-close" (click)="errorMessage = null"></button>
        </div>
        }
        @if(successMessage){
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="bi bi-check-circle-fill me-2"></i> {{ successMessage }}
          <button type="button" class="btn-close" (click)="successMessage = null"></button>
        </div>
        }
      </div>

      <h2 class="section-title mt-4">
        <i class="bi bi-clipboard-data me-2"></i> Detalles del Programa
      </h2>
      
      <div class="row">
        <div class="col-md-6 col-lg-4">
          <div class="mb-3">
            <label for="tipo_parto" class="label">Tipo de Parto <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-award"></i></span>
              <select id="tipo_parto" formControlName="tipo_parto" class="form-select" [ngClass]="{ 'is-invalid': programaForm.get('tipo_parto')?.invalid && programaForm.get('tipo_parto')?.touched }">
                <option value="" disabled>Seleccione...</option>
                @for(tipo of tiposDeParto; track tipo) {
                  <option [value]="tipo">{{ tipo }}</option>
                }
              </select>
            </div>
             @if(programaForm.get('tipo_parto')?.invalid && programaForm.get('tipo_parto')?.touched){
              <small class="text-danger d-block mt-1"><i class="bi bi-exclamation-circle me-1"></i> Campo obligatorio.</small>
             }
          </div>
        </div>

        <div class="col-md-6 col-lg-8">
          <div class="mb-3">
            <label for="complicacion" class="label">Complicación (Opcional)</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-exclamation-triangle"></i></span>
              <input type="text" id="complicacion" formControlName="complicacion" class="form-control" placeholder="Ej. Hemorragia postparto" maxlength="500" />
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="mb-3">
            <label for="observacion" class="label"><i class="bi bi-chat-text me-2"></i> Observaciones (Opcional)</label>
            <textarea id="observacion" formControlName="observacion" class="form-control" rows="4" placeholder="Detalles adicionales..." maxlength="1000"></textarea>
            <small class="text-muted d-block mt-1">
              {{ programaForm.get('observacion')?.value?.length || 0 }}/1000 caracteres
            </small>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button type="button" class="btn-volver" [routerLink]="['/puerperio']" [disabled]="isLoading">
          <i class="bi bi-arrow-left me-2"></i> Volver
        </button>
        <button type="submit" class="btn-submit" [disabled]="!canSubmit || isLoading">
          @if(isLoading){
            <span class="spinner-border spinner-border-sm me-2"></span>
          } @else {
            <i class="bi bi-check-circle me-2"></i>
          }
          {{ isEditMode ? 'Guardar Cambios' : 'Registrar Programa' }}
        </button>
      </div>
    </form>
  </div>
</div>